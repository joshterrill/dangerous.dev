---
title: Introduction to hunting malware in the wild
date: "2023-03-26T22:12:46.084Z"
description: Using domain zone files that contain lists of all active domains, we can search for fake websites, passing as 
being real websaites for already existing products, that offer downloads to software that has malware attached to it. In 
this article, we'll look at fake LastPass and Quickbooks sites trying to spread malware
tags: ["malware"]
published: true
---

# How to find fraudulant sites

ICANN is the internet's governing body that controls all domain TLD's, from publicly available ones such as .com, .net, 
.org, etc. to private ones registered by companies, like .audi, .nike, etc. (TODO:) We can register an account with ICANN 
[here](https://account.icann.org/registeraccount) and apply for access to certain TLD zone files 
[here](https://czds.icann.org/zone-requests/all). Once you have selected the TLD's you'd like to search, you should be 
approved for most within minutes, some might take a day or two. When I first created my account for the purpose of doing 
this research, I applied for access to every TLD they offered, and over the course of about a week, they all were approved.

If you don't want to go through ICANN, another way to get the same data would be to pay for it through a site like 
[zonefiles.io](https://zonefiles.io). You can pay for a month of service, download the zone files, and then cancel your 
membership.

# Searching the zone files

Depending on where you get the zone file, they can be as large as 7+GB gzipped. A trick I found to be able to search through 
these large zip files without extracting them is running a command like:

```bash
gunzip -c ALLZONES_zone_full.gz | grep "lastpass" > lastpass-domains.txt
gunzip -c ALLZONES_zone_full.gz | grep "quickbooks" > quickbooks-domains.txt
```
(TODO:)

Resulting in files like this:

`gist:joshterrill/38891d0eb2c1b15617e4a1abfc15b7a9#lastpass-domains-txt`

`gist:joshterrill/38891d0eb2c1b15617e4a1abfc15b7a9#quickbooks-domains-txt`

Going through these domains, we see that there are three categories the domains fall under.

1. It's a domain that the actual company owns, and they just own it so no one else can have it. These likely will redirect 
back to the main company website.

2. It's a domain that is parked and goes nowhere, or doesn't resolve to anything..

3. It's a domain that looks identical to the real product site, but isn't owned by the company, and is being used to spread 
downloads of the product with malware in it.

We can write a simple javascript script that loops through these domains and finds the ones that likely fall into the third 
category that we're interested in.

`gist:joshterrill/38891d0eb2c1b15617e4a1abfc15b7a9#domain-validator-js`
TODO: add https to the script

Running this script through our two domain files shrinks the resultset down significantly:

`gist:joshterrill/38891d0eb2c1b15617e4a1abfc15b7a9#lastpass-results-txt`

`gist:joshterrill/38891d0eb2c1b15617e4a1abfc15b7a9#towbrowser-results-txt`

# Analyzing LastPass malware

Looking through our list of LastPass domains, we come across a domain called https://lastpassword.org. It has a valid 
certificate, it looks identical to the actual https://lastpass.com website, however the download from this site is 
malicious. Clicking download gives us a file called `AppSetup.exe` from https://www.ozturk-web.com/catpcha/AppSetup.exe 
(TODO: check link and make hyperlink)

A few things are immediately suspicious about this.

1. The domain https://lastpassword.org doesn't redirect to https://lastpass.com, despite it looking identical
2. The download link points to a different domain
3. The file that is downloaded is a generic name, `AppSetup.exe`
4. The filesize for `AppSetup.exe` is over 800mb's when the real LastPass executable is ~10mb's (TODO: fact check this). The 
reason why it's likely so large is to  disuade people from uploading it to something like (Virus 
Total)[https://virustotal.com] which has a max upload limit of 650mb. This is likely accomplished through some sort of 
packer or obfuscation.
 5. If we zip the contents up and upload the compressed zip to Virus Total, we get several hits: 
https://www.virustotal.com/gui/file/3727544a95fe98f0ebbd0d8138bdae745af64e88cb18eebe7dd04ae0eba49005

![AppSetup zip file analyzed through Virus Total](./assets/virus-total-appset-exe.png)

Analyzing the exe file in IDA Pro we have a single import, a single export, a lot of junk-code functions, and a reference to 
the actual name of this exe: `Hatlikepsi.exe`.

(TODO: IDA in windows VM that shows the packer name)

Now that we've identified that it has been packed with Eziriz's .NET Reactor, we can use a tool like 
(NETReactorSlayer)[https://github.com/SychicBoy/NETReactorSlayer] to unpack it easily.

(TODO: get screenshot of unpacking process)


# Analyzing Tor Browser malware
(TODO:)

# Conclusion

These are just a couple of examples of how someone can find and research malware in the wild, and these are just two ideas 
for companies and products to target to search for this malicious software being passed as legit. Some other ideas for 
products or comapnies to search are: VMWare, ImgBurn, Microsoft Word, ExpressVPN, and Dropbox. If you find anything 
interesting, feel free to share it!
